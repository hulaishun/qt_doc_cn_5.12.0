<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<!-- btchat.qdoc -->
  <title>Bluetooth Chat Example | Qt Bluetooth 5.12</title>
  <link rel="stylesheet" type="text/css" href="style/offline-simple.css" />
  <script type="text/javascript">
    document.getElementsByTagName("link").item(0).setAttribute("href", "style/offline.css");
    // loading style sheet breaks anchors that were jumped to before
    // so force jumping to anchor again
    setTimeout(function() {
        var anchor = location.hash;
        // need to jump to different anchor first (e.g. none)
        location.hash = "#";
        setTimeout(function() {
            location.hash = anchor;
        }, 0);
    }, 0);
  </script>
</head>
<body>
<div class="header" id="qtdocheader">
  <div class="main">
    <div class="main-rounded">
      <div class="navigationbar">
        <table><tr>
<td ><a href="../qtdoc/index.html">Qt 5.12</a></td><td ><a href="qtbluetooth-index.html">Qt蓝牙</a></td><td >Bluetooth Chat Example</td></tr></table><table class="buildversion"><tr>
<td id="buildversion" width="100%" align="right">Qt5.12.0参考文档</td>
        </tr></table>
      </div>
    </div>
<div class="content">
<div class="line">
<div class="content mainContent">
<div class="sidebar">
<div class="toc">
<h3><a name="toc">目录</a></h3>
<ul>
<li class="level1"><a href="#running-the-example">Running the Example</a></li>
<li class="level1"><a href="#chat-server">Chat Server</a></li>
<li class="level1"><a href="#chat-client">Chat Client</a></li>
<li class="level1"><a href="#chat-dialog">Chat Dialog</a></li>
</ul>
</div>
<div class="sidebar-content" id="sidebar-content"></div></div>
<h1 class="title">Bluetooth Chat Example</h1>
<span class="subtitle"></span>
<!-- $$$btchat-brief -->
<p>An example showing communication through Bluetooth.</p>
<!-- @@@btchat -->
<!-- $$$btchat-description -->
<div class="descr"> <a name="details"></a>
<p>The Bluetooth Chat example shows how to use the <a href="qtbluetooth-index.html">Qt蓝牙</a> API to communicate with another application on a remote device using Bluetooth.</p>
<p class="centerAlign"><img src="images/btchat-example.png" alt="" /></p><p>The Bluetooth Chat example implements a simple chat program between multiple parties. The application always acts as both a server and a client eliminating the need to determine who should connect to whom.</p>
<a name="running-the-example"></a>
<h2 id="running-the-example">Running the Example</h2>
<p>To run the example from <a href="http://doc.qt.io/qtcreator/index.html">Qt Creator</a>, open the <b>Welcome</b> mode and select the example from <b>样例</b>. For more information, visit <a href="http://doc.qt.io/qtcreator/creator-build-example-application.html">Building and Running an Example</a>.</p>
<a name="chat-server"></a>
<h2 id="chat-server">Chat Server</h2>
<p>The chat server is implemented by the ChatServer class. The ChatServer class is declared as:</p>
<pre class="cpp">

  <span class="keyword">class</span> ChatServer : <span class="keyword">public</span> <span class="type"><a href="../qtcore/qobject.html">QObject</a></span>
  {
      Q_OBJECT

  <span class="keyword">public</span>:
      <span class="keyword">explicit</span> ChatServer(<span class="type"><a href="../qtcore/qobject.html">QObject</a></span> <span class="operator">*</span>parent <span class="operator">=</span> nullptr);
      <span class="operator">~</span>ChatServer();

      <span class="type">void</span> startServer(<span class="keyword">const</span> <span class="type"><a href="qbluetoothaddress.html">QBluetoothAddress</a></span> <span class="operator">&amp;</span>localAdapter <span class="operator">=</span> <span class="type"><a href="qbluetoothaddress.html">QBluetoothAddress</a></span>());
      <span class="type">void</span> stopServer();

  <span class="keyword">public</span> <span class="keyword">slots</span>:
      <span class="type">void</span> sendMessage(<span class="keyword">const</span> <span class="type"><a href="../qtcore/qstring.html">QString</a></span> <span class="operator">&amp;</span>message);

  <span class="keyword">signals</span>:
      <span class="type">void</span> messageReceived(<span class="keyword">const</span> <span class="type"><a href="../qtcore/qstring.html">QString</a></span> <span class="operator">&amp;</span>sender<span class="operator">,</span> <span class="keyword">const</span> <span class="type"><a href="../qtcore/qstring.html">QString</a></span> <span class="operator">&amp;</span>message);
      <span class="type">void</span> clientConnected(<span class="keyword">const</span> <span class="type"><a href="../qtcore/qstring.html">QString</a></span> <span class="operator">&amp;</span>name);
      <span class="type">void</span> clientDisconnected(<span class="keyword">const</span> <span class="type"><a href="../qtcore/qstring.html">QString</a></span> <span class="operator">&amp;</span>name);

  <span class="keyword">private</span> <span class="keyword">slots</span>:
      <span class="type">void</span> clientConnected();
      <span class="type">void</span> clientDisconnected();
      <span class="type">void</span> readSocket();

  <span class="keyword">private</span>:
      <span class="type"><a href="qbluetoothserver.html">QBluetoothServer</a></span> <span class="operator">*</span>rfcommServer <span class="operator">=</span> nullptr;
      <span class="type"><a href="qbluetoothserviceinfo.html">QBluetoothServiceInfo</a></span> serviceInfo;
      <span class="type"><a href="../qtcore/qlist.html">QList</a></span><span class="operator">&lt;</span><span class="type"><a href="qbluetoothsocket.html">QBluetoothSocket</a></span> <span class="operator">*</span><span class="operator">&gt;</span> clientSockets;
  };

</pre>
<p>The first thing the chat server needs to do is create an instance of QRfcommServer to listen for incoming Bluetooth connections. Our clientConnected() slot will be called whenever a new connection is created.</p>
<pre class="cpp">

  rfcommServer <span class="operator">=</span> <span class="keyword">new</span> <span class="type"><a href="qbluetoothserver.html">QBluetoothServer</a></span>(<span class="type"><a href="qbluetoothserviceinfo.html">QBluetoothServiceInfo</a></span><span class="operator">::</span>RfcommProtocol<span class="operator">,</span> <span class="keyword">this</span>);
  connect(rfcommServer<span class="operator">,</span> <span class="operator">&amp;</span><span class="type"><a href="qbluetoothserver.html">QBluetoothServer</a></span><span class="operator">::</span>newConnection<span class="operator">,</span>
          <span class="keyword">this</span><span class="operator">,</span> <span class="type">QOverload</span><span class="operator">&lt;</span><span class="operator">&gt;</span><span class="operator">::</span>of(<span class="operator">&amp;</span>ChatServer<span class="operator">::</span>clientConnected));
  bool result <span class="operator">=</span> rfcommServer<span class="operator">-</span><span class="operator">&gt;</span>listen(localAdapter);
  <span class="keyword">if</span> (<span class="operator">!</span>result) {
      <a href="../qtcore/qtglobal.html#qWarning">qWarning</a>() <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="string">&quot;Cannot bind chat server to&quot;</span> <span class="operator">&lt;</span><span class="operator">&lt;</span> localAdapter<span class="operator">.</span>toString();
      <span class="keyword">return</span>;
  }

</pre>
<p>The chat server is only useful if others know that it is there. To enable other devices to discover it, a record describing the service needs to be published in the systems SDP (Service Discovery Protocol) database. The <a href="qbluetoothserviceinfo.html">QBluetoothServiceInfo</a> class encapsulates a service record.</p>
<p>We will publish a service record that contains some textural descriptions of the services, a UUID that uniquely identifies the service, the discoverability attribute, and connection parameters.</p>
<p>The textural description of the service is stored in the ServiceName, ServiceDescription, and ServiceProvider attributes.</p>
<pre class="cpp">

  serviceInfo<span class="operator">.</span>setAttribute(<span class="type"><a href="qbluetoothserviceinfo.html">QBluetoothServiceInfo</a></span><span class="operator">::</span>ServiceName<span class="operator">,</span> tr(<span class="string">&quot;Bt Chat Server&quot;</span>));
  serviceInfo<span class="operator">.</span>setAttribute(<span class="type"><a href="qbluetoothserviceinfo.html">QBluetoothServiceInfo</a></span><span class="operator">::</span>ServiceDescription<span class="operator">,</span>
                           tr(<span class="string">&quot;Example bluetooth chat server&quot;</span>));
  serviceInfo<span class="operator">.</span>setAttribute(<span class="type"><a href="qbluetoothserviceinfo.html">QBluetoothServiceInfo</a></span><span class="operator">::</span>ServiceProvider<span class="operator">,</span> tr(<span class="string">&quot;qt-project.org&quot;</span>));

</pre>
<p>Bluetooth uses UUIDs as unique identifiers. The chat service uses a randomly generated UUID.</p>
<pre class="cpp">

  <span class="keyword">static</span> <span class="keyword">const</span> QLatin1String serviceUuid(<span class="string">&quot;e8e10f95-1a70-4b27-9ccf-02010264e9c8&quot;</span>);
  serviceInfo<span class="operator">.</span>setServiceUuid(<span class="type"><a href="qbluetoothuuid.html">QBluetoothUuid</a></span>(serviceUuid));

</pre>
<p>A Bluetooth service is only discoverable if it is in the PublicBrowseGroup.</p>
<pre class="cpp">

  <span class="type"><a href="qbluetoothserviceinfo.html">QBluetoothServiceInfo</a></span><span class="operator">::</span>Sequence publicBrowse;
  publicBrowse <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="../qtcore/qvariant.html">QVariant</a></span><span class="operator">::</span>fromValue(<span class="type"><a href="qbluetoothuuid.html">QBluetoothUuid</a></span>(<span class="type"><a href="qbluetoothuuid.html">QBluetoothUuid</a></span><span class="operator">::</span>PublicBrowseGroup));
  serviceInfo<span class="operator">.</span>setAttribute(<span class="type"><a href="qbluetoothserviceinfo.html">QBluetoothServiceInfo</a></span><span class="operator">::</span>BrowseGroupList<span class="operator">,</span>
                           publicBrowse);

</pre>
<p>The ProtocolDescriptorList attribute is used to publish the connection parameters that the remote device requires to connect to our service. Here we specify that the Rfcomm protocol is used and set the port number to the port that our rfcommServer instance is listening to.</p>
<pre class="cpp">

  <span class="type"><a href="qbluetoothserviceinfo.html">QBluetoothServiceInfo</a></span><span class="operator">::</span>Sequence protocolDescriptorList;
  <span class="type"><a href="qbluetoothserviceinfo.html">QBluetoothServiceInfo</a></span><span class="operator">::</span>Sequence protocol;
  protocol <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="../qtcore/qvariant.html">QVariant</a></span><span class="operator">::</span>fromValue(<span class="type"><a href="qbluetoothuuid.html">QBluetoothUuid</a></span>(<span class="type"><a href="qbluetoothuuid.html">QBluetoothUuid</a></span><span class="operator">::</span>L2cap));
  protocolDescriptorList<span class="operator">.</span>append(<span class="type"><a href="../qtcore/qvariant.html">QVariant</a></span><span class="operator">::</span>fromValue(protocol));
  protocol<span class="operator">.</span>clear();
  protocol <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="../qtcore/qvariant.html">QVariant</a></span><span class="operator">::</span>fromValue(<span class="type"><a href="qbluetoothuuid.html">QBluetoothUuid</a></span>(<span class="type"><a href="qbluetoothuuid.html">QBluetoothUuid</a></span><span class="operator">::</span>Rfcomm))
           <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="../qtcore/qvariant.html">QVariant</a></span><span class="operator">::</span>fromValue(<span class="type"><a href="../qtcore/qtglobal.html#quint8-typedef">quint8</a></span>(rfcommServer<span class="operator">-</span><span class="operator">&gt;</span>serverPort()));
  protocolDescriptorList<span class="operator">.</span>append(<span class="type"><a href="../qtcore/qvariant.html">QVariant</a></span><span class="operator">::</span>fromValue(protocol));
  serviceInfo<span class="operator">.</span>setAttribute(<span class="type"><a href="qbluetoothserviceinfo.html">QBluetoothServiceInfo</a></span><span class="operator">::</span>ProtocolDescriptorList<span class="operator">,</span>
                           protocolDescriptorList);

</pre>
<p>Finally, we register the service record with the system.</p>
<pre class="cpp">

  serviceInfo<span class="operator">.</span>registerService(localAdapter);

</pre>
<p>As mentioned earlier, incoming connections are handled in the clientConnected() slot where pending connections are connected to the readyRead() and disconnected() signals. The signals notify others that a new client has connected.</p>
<pre class="cpp">

  <span class="type">void</span> ChatServer<span class="operator">::</span>clientConnected()
  {
      <span class="type"><a href="qbluetoothsocket.html">QBluetoothSocket</a></span> <span class="operator">*</span>socket <span class="operator">=</span> rfcommServer<span class="operator">-</span><span class="operator">&gt;</span>nextPendingConnection();
      <span class="keyword">if</span> (<span class="operator">!</span>socket)
          <span class="keyword">return</span>;

      connect(socket<span class="operator">,</span> <span class="operator">&amp;</span><span class="type"><a href="qbluetoothsocket.html">QBluetoothSocket</a></span><span class="operator">::</span>readyRead<span class="operator">,</span> <span class="keyword">this</span><span class="operator">,</span> <span class="operator">&amp;</span>ChatServer<span class="operator">::</span>readSocket);
      connect(socket<span class="operator">,</span> <span class="operator">&amp;</span><span class="type"><a href="qbluetoothsocket.html">QBluetoothSocket</a></span><span class="operator">::</span>disconnected<span class="operator">,</span> <span class="keyword">this</span><span class="operator">,</span> <span class="type">QOverload</span><span class="operator">&lt;</span><span class="operator">&gt;</span><span class="operator">::</span>of(<span class="operator">&amp;</span>ChatServer<span class="operator">::</span>clientDisconnected));
      clientSockets<span class="operator">.</span>append(socket);
      <span class="keyword">emit</span> clientConnected(socket<span class="operator">-</span><span class="operator">&gt;</span>peerName());
  }

</pre>
<p>The readSocket() slot is called whenever data is ready to be read from a client socket. The slot reads individual lines from the socket, converts them from UTF-8, and emits the messageReceived() signal.</p>
<pre class="cpp">

  <span class="type">void</span> ChatServer<span class="operator">::</span>readSocket()
  {
      <span class="type"><a href="qbluetoothsocket.html">QBluetoothSocket</a></span> <span class="operator">*</span>socket <span class="operator">=</span> qobject_cast<span class="operator">&lt;</span><span class="type"><a href="qbluetoothsocket.html">QBluetoothSocket</a></span> <span class="operator">*</span><span class="operator">&gt;</span>(sender());
      <span class="keyword">if</span> (<span class="operator">!</span>socket)
          <span class="keyword">return</span>;

      <span class="keyword">while</span> (socket<span class="operator">-</span><span class="operator">&gt;</span>canReadLine()) {
          <span class="type"><a href="../qtcore/qbytearray.html">QByteArray</a></span> line <span class="operator">=</span> socket<span class="operator">-</span><span class="operator">&gt;</span>readLine()<span class="operator">.</span>trimmed();
          <span class="keyword">emit</span> messageReceived(socket<span class="operator">-</span><span class="operator">&gt;</span>peerName()<span class="operator">,</span>
                               <span class="type"><a href="../qtcore/qstring.html">QString</a></span><span class="operator">::</span>fromUtf8(line<span class="operator">.</span>constData()<span class="operator">,</span> line<span class="operator">.</span>length()));
      }
  }

</pre>
<p>The clientDisconnected() slot is called whenever a client disconnects from the service. The slot emits a signal to notify others that a client has disconnected, and deletes the socket.</p>
<pre class="cpp">

  <span class="type">void</span> ChatServer<span class="operator">::</span>clientDisconnected()
  {
      <span class="type"><a href="qbluetoothsocket.html">QBluetoothSocket</a></span> <span class="operator">*</span>socket <span class="operator">=</span> qobject_cast<span class="operator">&lt;</span><span class="type"><a href="qbluetoothsocket.html">QBluetoothSocket</a></span> <span class="operator">*</span><span class="operator">&gt;</span>(sender());
      <span class="keyword">if</span> (<span class="operator">!</span>socket)
          <span class="keyword">return</span>;

      <span class="keyword">emit</span> clientDisconnected(socket<span class="operator">-</span><span class="operator">&gt;</span>peerName());

      clientSockets<span class="operator">.</span>removeOne(socket);

      socket<span class="operator">-</span><span class="operator">&gt;</span>deleteLater();
  }

</pre>
<p>The sendMessage() slot is used to send a message to all connected clients. The message is converted into UTF-8 and appended with a newline before being sent to all clients.</p>
<pre class="cpp">

  <span class="type">void</span> ChatServer<span class="operator">::</span>sendMessage(<span class="keyword">const</span> <span class="type"><a href="../qtcore/qstring.html">QString</a></span> <span class="operator">&amp;</span>message)
  {
      <span class="type"><a href="../qtcore/qbytearray.html">QByteArray</a></span> text <span class="operator">=</span> message<span class="operator">.</span>toUtf8() <span class="operator">+</span> <span class="char">'\n'</span>;

      <span class="keyword">for</span> (<span class="type"><a href="qbluetoothsocket.html">QBluetoothSocket</a></span> <span class="operator">*</span>socket : <a href="../qtcore/qtglobal.html#qAsConst">qAsConst</a>(clientSockets))
          socket<span class="operator">-</span><span class="operator">&gt;</span>write(text);
  }

</pre>
<p>When the chat server is stopped the service record is removed from the system SDP database, all connected client sockets are deleted, and the QRfcommServer instance is deleted.</p>
<pre class="cpp">

  <span class="type">void</span> ChatServer<span class="operator">::</span>stopServer()
  {
      <span class="comment">// Unregister service</span>
      serviceInfo<span class="operator">.</span>unregisterService();

      <span class="comment">// Close sockets</span>
      <a href="../qtcore/qtalgorithms.html#qDeleteAll">qDeleteAll</a>(clientSockets);

      <span class="comment">// Close server</span>
      <span class="keyword">delete</span> rfcommServer;
      rfcommServer <span class="operator">=</span> nullptr;
  }

</pre>
<a name="chat-client"></a>
<h2 id="chat-client">Chat Client</h2>
<p>The chat client is implemented by the ChatClient class. The ChatClient class is declared as:</p>
<pre class="cpp">

  <span class="keyword">class</span> ChatClient : <span class="keyword">public</span> <span class="type"><a href="../qtcore/qobject.html">QObject</a></span>
  {
      Q_OBJECT

  <span class="keyword">public</span>:
      <span class="keyword">explicit</span> ChatClient(<span class="type"><a href="../qtcore/qobject.html">QObject</a></span> <span class="operator">*</span>parent <span class="operator">=</span> nullptr);
      <span class="operator">~</span>ChatClient();

      <span class="type">void</span> startClient(<span class="keyword">const</span> <span class="type"><a href="qbluetoothserviceinfo.html">QBluetoothServiceInfo</a></span> <span class="operator">&amp;</span>remoteService);
      <span class="type">void</span> stopClient();

  <span class="keyword">public</span> <span class="keyword">slots</span>:
      <span class="type">void</span> sendMessage(<span class="keyword">const</span> <span class="type"><a href="../qtcore/qstring.html">QString</a></span> <span class="operator">&amp;</span>message);

  <span class="keyword">signals</span>:
      <span class="type">void</span> messageReceived(<span class="keyword">const</span> <span class="type"><a href="../qtcore/qstring.html">QString</a></span> <span class="operator">&amp;</span>sender<span class="operator">,</span> <span class="keyword">const</span> <span class="type"><a href="../qtcore/qstring.html">QString</a></span> <span class="operator">&amp;</span>message);
      <span class="type">void</span> connected(<span class="keyword">const</span> <span class="type"><a href="../qtcore/qstring.html">QString</a></span> <span class="operator">&amp;</span>name);
      <span class="type">void</span> disconnected();
      <span class="type">void</span> socketErrorOccurred(<span class="keyword">const</span> <span class="type"><a href="../qtcore/qstring.html">QString</a></span> <span class="operator">&amp;</span>errorString);

  <span class="keyword">private</span> <span class="keyword">slots</span>:
      <span class="type">void</span> readSocket();
      <span class="type">void</span> connected();
      <span class="type">void</span> onSocketErrorOccurred(<span class="type"><a href="qbluetoothsocket.html">QBluetoothSocket</a></span><span class="operator">::</span>SocketError);

  <span class="keyword">private</span>:
      <span class="type"><a href="qbluetoothsocket.html">QBluetoothSocket</a></span> <span class="operator">*</span>socket <span class="operator">=</span> nullptr;
  };

</pre>
<p>The client creates a new <a href="qbluetoothsocket.html">QBluetoothSocket</a> and connects to the remote service described by the <i>remoteService</i> parameter. Slots are connected to the sockets readyRead(), connected() and disconnected() signals.</p>
<pre class="cpp">

  <span class="type">void</span> ChatClient<span class="operator">::</span>startClient(<span class="keyword">const</span> <span class="type"><a href="qbluetoothserviceinfo.html">QBluetoothServiceInfo</a></span> <span class="operator">&amp;</span>remoteService)
  {
      <span class="keyword">if</span> (socket)
          <span class="keyword">return</span>;

      <span class="comment">// Connect to service</span>
      socket <span class="operator">=</span> <span class="keyword">new</span> <span class="type"><a href="qbluetoothsocket.html">QBluetoothSocket</a></span>(<span class="type"><a href="qbluetoothserviceinfo.html">QBluetoothServiceInfo</a></span><span class="operator">::</span>RfcommProtocol);
      <a href="../qtcore/qtglobal.html#qDebug">qDebug</a>() <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="string">&quot;Create socket&quot;</span>;
      socket<span class="operator">-</span><span class="operator">&gt;</span>connectToService(remoteService);
      <a href="../qtcore/qtglobal.html#qDebug">qDebug</a>() <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="string">&quot;ConnectToService done&quot;</span>;

      connect(socket<span class="operator">,</span> <span class="operator">&amp;</span><span class="type"><a href="qbluetoothsocket.html">QBluetoothSocket</a></span><span class="operator">::</span>readyRead<span class="operator">,</span> <span class="keyword">this</span><span class="operator">,</span> <span class="operator">&amp;</span>ChatClient<span class="operator">::</span>readSocket);
      connect(socket<span class="operator">,</span> <span class="operator">&amp;</span><span class="type"><a href="qbluetoothsocket.html">QBluetoothSocket</a></span><span class="operator">::</span>connected<span class="operator">,</span> <span class="keyword">this</span><span class="operator">,</span> <span class="type">QOverload</span><span class="operator">&lt;</span><span class="operator">&gt;</span><span class="operator">::</span>of(<span class="operator">&amp;</span>ChatClient<span class="operator">::</span>connected));
      connect(socket<span class="operator">,</span> <span class="operator">&amp;</span><span class="type"><a href="qbluetoothsocket.html">QBluetoothSocket</a></span><span class="operator">::</span>disconnected<span class="operator">,</span> <span class="keyword">this</span><span class="operator">,</span> <span class="operator">&amp;</span>ChatClient<span class="operator">::</span>disconnected);
      connect(socket<span class="operator">,</span> <span class="type">QOverload</span><span class="operator">&lt;</span><span class="type"><a href="qbluetoothsocket.html">QBluetoothSocket</a></span><span class="operator">::</span>SocketError<span class="operator">&gt;</span><span class="operator">::</span>of(<span class="operator">&amp;</span><span class="type"><a href="qbluetoothsocket.html">QBluetoothSocket</a></span><span class="operator">::</span>error)<span class="operator">,</span>
              <span class="keyword">this</span><span class="operator">,</span> <span class="operator">&amp;</span>ChatClient<span class="operator">::</span>onSocketErrorOccurred);

  }

</pre>
<p>On successful socket connection we emit a signal to notify others.</p>
<pre class="cpp">

  <span class="type">void</span> ChatClient<span class="operator">::</span>connected()
  {
      <span class="keyword">emit</span> connected(socket<span class="operator">-</span><span class="operator">&gt;</span>peerName());
  }

</pre>
<p>Similarly to the chat server, the readSocket() slot is called when data is available from the socket. Lines are read individually and converted from UTF-8. The messageReceived() signal is emitted.</p>
<pre class="cpp">

  <span class="type">void</span> ChatClient<span class="operator">::</span>readSocket()
  {
      <span class="keyword">if</span> (<span class="operator">!</span>socket)
          <span class="keyword">return</span>;

      <span class="keyword">while</span> (socket<span class="operator">-</span><span class="operator">&gt;</span>canReadLine()) {
          <span class="type"><a href="../qtcore/qbytearray.html">QByteArray</a></span> line <span class="operator">=</span> socket<span class="operator">-</span><span class="operator">&gt;</span>readLine();
          <span class="keyword">emit</span> messageReceived(socket<span class="operator">-</span><span class="operator">&gt;</span>peerName()<span class="operator">,</span>
                               <span class="type"><a href="../qtcore/qstring.html">QString</a></span><span class="operator">::</span>fromUtf8(line<span class="operator">.</span>constData()<span class="operator">,</span> line<span class="operator">.</span>length()));
      }
  }

</pre>
<p>The sendMessage() slot is used to send a message to the remote device. The message is converted to UTF-8 and a newline is appended.</p>
<pre class="cpp">

  <span class="type">void</span> ChatClient<span class="operator">::</span>sendMessage(<span class="keyword">const</span> <span class="type"><a href="../qtcore/qstring.html">QString</a></span> <span class="operator">&amp;</span>message)
  {
      <span class="type"><a href="../qtcore/qbytearray.html">QByteArray</a></span> text <span class="operator">=</span> message<span class="operator">.</span>toUtf8() <span class="operator">+</span> <span class="char">'\n'</span>;
      socket<span class="operator">-</span><span class="operator">&gt;</span>write(text);
  }

</pre>
<p>To disconnect from the remote chat service, the <a href="qbluetoothsocket.html">QBluetoothSocket</a> instance is deleted.</p>
<pre class="cpp">

  <span class="type">void</span> ChatClient<span class="operator">::</span>stopClient()
  {
      <span class="keyword">delete</span> socket;
      socket <span class="operator">=</span> nullptr;
  }

</pre>
<a name="chat-dialog"></a>
<h2 id="chat-dialog">Chat Dialog</h2>
<p>The main window of this example is the chat dialog, implemented in the Chat class. This class displays a chat session between a single ChatServer and zero or more ChatClients. The Chat class is declared as:</p>
<pre class="cpp">

  <span class="keyword">class</span> Chat : <span class="keyword">public</span> <span class="type">QDialog</span>
  {
      Q_OBJECT

  <span class="keyword">public</span>:
      <span class="keyword">explicit</span> Chat(<span class="type">QWidget</span> <span class="operator">*</span>parent <span class="operator">=</span> nullptr);
      <span class="operator">~</span>Chat();

  <span class="keyword">signals</span>:
      <span class="type">void</span> sendMessage(<span class="keyword">const</span> <span class="type"><a href="../qtcore/qstring.html">QString</a></span> <span class="operator">&amp;</span>message);

  <span class="keyword">private</span> <span class="keyword">slots</span>:
      <span class="type">void</span> connectClicked();
      <span class="type">void</span> sendClicked();

      <span class="type">void</span> showMessage(<span class="keyword">const</span> <span class="type"><a href="../qtcore/qstring.html">QString</a></span> <span class="operator">&amp;</span>sender<span class="operator">,</span> <span class="keyword">const</span> <span class="type"><a href="../qtcore/qstring.html">QString</a></span> <span class="operator">&amp;</span>message);

      <span class="type">void</span> clientConnected(<span class="keyword">const</span> <span class="type"><a href="../qtcore/qstring.html">QString</a></span> <span class="operator">&amp;</span>name);
      <span class="type">void</span> clientDisconnected(<span class="keyword">const</span> <span class="type"><a href="../qtcore/qstring.html">QString</a></span> <span class="operator">&amp;</span>name);
      <span class="type">void</span> clientDisconnected();
      <span class="type">void</span> connected(<span class="keyword">const</span> <span class="type"><a href="../qtcore/qstring.html">QString</a></span> <span class="operator">&amp;</span>name);
      <span class="type">void</span> reactOnSocketError(<span class="keyword">const</span> <span class="type"><a href="../qtcore/qstring.html">QString</a></span> <span class="operator">&amp;</span>error);

      <span class="type">void</span> newAdapterSelected();

  <span class="keyword">private</span>:
      <span class="type">int</span> adapterFromUserSelection() <span class="keyword">const</span>;
      <span class="type">int</span> currentAdapterIndex <span class="operator">=</span> <span class="number">0</span>;
      Ui_Chat <span class="operator">*</span>ui;

      ChatServer <span class="operator">*</span>server;
      <span class="type"><a href="../qtcore/qlist.html">QList</a></span><span class="operator">&lt;</span>ChatClient <span class="operator">*</span><span class="operator">&gt;</span> clients;
      <span class="type"><a href="../qtcore/qlist.html">QList</a></span><span class="operator">&lt;</span><span class="type"><a href="qbluetoothhostinfo.html">QBluetoothHostInfo</a></span><span class="operator">&gt;</span> localAdapters;

      <span class="type"><a href="../qtcore/qstring.html">QString</a></span> localName;
  };

</pre>
<p>First we construct the user interface</p>
<pre class="cpp">

  ui<span class="operator">-</span><span class="operator">&gt;</span>setupUi(<span class="keyword">this</span>);

  connect(ui<span class="operator">-</span><span class="operator">&gt;</span>quitButton<span class="operator">,</span> <span class="operator">&amp;</span><span class="type">QPushButton</span><span class="operator">::</span>clicked<span class="operator">,</span> <span class="keyword">this</span><span class="operator">,</span> <span class="operator">&amp;</span>Chat<span class="operator">::</span>accept);
  connect(ui<span class="operator">-</span><span class="operator">&gt;</span>connectButton<span class="operator">,</span> <span class="operator">&amp;</span><span class="type">QPushButton</span><span class="operator">::</span>clicked<span class="operator">,</span> <span class="keyword">this</span><span class="operator">,</span> <span class="operator">&amp;</span>Chat<span class="operator">::</span>connectClicked);
  connect(ui<span class="operator">-</span><span class="operator">&gt;</span>sendButton<span class="operator">,</span> <span class="operator">&amp;</span><span class="type">QPushButton</span><span class="operator">::</span>clicked<span class="operator">,</span> <span class="keyword">this</span><span class="operator">,</span> <span class="operator">&amp;</span>Chat<span class="operator">::</span>sendClicked);

</pre>
<p>We create an instance of the ChatServer and respond to its clientConnected(), clientDiconnected(), and messageReceived() signals.</p>
<pre class="cpp">

  server <span class="operator">=</span> <span class="keyword">new</span> ChatServer(<span class="keyword">this</span>);
  connect(server<span class="operator">,</span> <span class="type">QOverload</span><span class="operator">&lt;</span><span class="keyword">const</span> <span class="type"><a href="../qtcore/qstring.html">QString</a></span> <span class="operator">&amp;</span><span class="operator">&gt;</span><span class="operator">::</span>of(<span class="operator">&amp;</span>ChatServer<span class="operator">::</span>clientConnected)<span class="operator">,</span>
          <span class="keyword">this</span><span class="operator">,</span> <span class="operator">&amp;</span>Chat<span class="operator">::</span>clientConnected);
  connect(server<span class="operator">,</span> <span class="type">QOverload</span><span class="operator">&lt;</span><span class="keyword">const</span> <span class="type"><a href="../qtcore/qstring.html">QString</a></span> <span class="operator">&amp;</span><span class="operator">&gt;</span><span class="operator">::</span>of(<span class="operator">&amp;</span>ChatServer<span class="operator">::</span>clientDisconnected)<span class="operator">,</span>
          <span class="keyword">this</span><span class="operator">,</span>  <span class="type">QOverload</span><span class="operator">&lt;</span><span class="keyword">const</span> <span class="type"><a href="../qtcore/qstring.html">QString</a></span> <span class="operator">&amp;</span><span class="operator">&gt;</span><span class="operator">::</span>of(<span class="operator">&amp;</span>Chat<span class="operator">::</span>clientDisconnected));
  connect(server<span class="operator">,</span> <span class="operator">&amp;</span>ChatServer<span class="operator">::</span>messageReceived<span class="operator">,</span>
          <span class="keyword">this</span><span class="operator">,</span>  <span class="operator">&amp;</span>Chat<span class="operator">::</span>showMessage);
  connect(<span class="keyword">this</span><span class="operator">,</span> <span class="operator">&amp;</span>Chat<span class="operator">::</span>sendMessage<span class="operator">,</span> server<span class="operator">,</span> <span class="operator">&amp;</span>ChatServer<span class="operator">::</span>sendMessage);
  server<span class="operator">-</span><span class="operator">&gt;</span>startServer();

</pre>
<p>In response to the clientConnected() and clientDisconnected() signals of the ChatServer, we display the typical &quot;X has joined chat.&quot; and &quot;Y has left.&quot; messages in the chat session.</p>
<pre class="cpp">

  <span class="type">void</span> Chat<span class="operator">::</span>clientConnected(<span class="keyword">const</span> <span class="type"><a href="../qtcore/qstring.html">QString</a></span> <span class="operator">&amp;</span>name)
  {
      ui<span class="operator">-</span><span class="operator">&gt;</span>chat<span class="operator">-</span><span class="operator">&gt;</span>insertPlainText(<span class="type"><a href="../qtcore/qstring.html">QString</a></span><span class="operator">::</span>fromLatin1(<span class="string">&quot;%1 has joined chat.\n&quot;</span>)<span class="operator">.</span>arg(name));
  }

  <span class="type">void</span> Chat<span class="operator">::</span>clientDisconnected(<span class="keyword">const</span> <span class="type"><a href="../qtcore/qstring.html">QString</a></span> <span class="operator">&amp;</span>name)
  {
      ui<span class="operator">-</span><span class="operator">&gt;</span>chat<span class="operator">-</span><span class="operator">&gt;</span>insertPlainText(<span class="type"><a href="../qtcore/qstring.html">QString</a></span><span class="operator">::</span>fromLatin1(<span class="string">&quot;%1 has left.\n&quot;</span>)<span class="operator">.</span>arg(name));
  }

</pre>
<p>Incoming messages from clients connected to the ChatServer are handled in the showMessage() slot. The message text tagged with the remote device name is displayed in the chat session.</p>
<pre class="cpp">

  <span class="type">void</span> Chat<span class="operator">::</span>showMessage(<span class="keyword">const</span> <span class="type"><a href="../qtcore/qstring.html">QString</a></span> <span class="operator">&amp;</span>sender<span class="operator">,</span> <span class="keyword">const</span> <span class="type"><a href="../qtcore/qstring.html">QString</a></span> <span class="operator">&amp;</span>message)
  {
      ui<span class="operator">-</span><span class="operator">&gt;</span>chat<span class="operator">-</span><span class="operator">&gt;</span>insertPlainText(<span class="type"><a href="../qtcore/qstring.html">QString</a></span><span class="operator">::</span>fromLatin1(<span class="string">&quot;%1: %2\n&quot;</span>)<span class="operator">.</span>arg(sender<span class="operator">,</span> message));
      ui<span class="operator">-</span><span class="operator">&gt;</span>chat<span class="operator">-</span><span class="operator">&gt;</span>ensureCursorVisible();
  }

</pre>
<p>In response to the connect button being clicked, the application starts service discovery and presents a list of discovered chat services on remote devices. A ChatClient for the service is selected by the user.</p>
<pre class="cpp">

  <span class="type">void</span> Chat<span class="operator">::</span>connectClicked()
  {
      ui<span class="operator">-</span><span class="operator">&gt;</span>connectButton<span class="operator">-</span><span class="operator">&gt;</span>setEnabled(<span class="keyword">false</span>);

      <span class="comment">// scan for services</span>
      <span class="keyword">const</span> <span class="type"><a href="qbluetoothaddress.html">QBluetoothAddress</a></span> adapter <span class="operator">=</span> localAdapters<span class="operator">.</span>isEmpty() <span class="operator">?</span>
                                             <span class="type"><a href="qbluetoothaddress.html">QBluetoothAddress</a></span>() :
                                             localAdapters<span class="operator">.</span>at(currentAdapterIndex)<span class="operator">.</span>address();

      RemoteSelector remoteSelector(adapter);
  <span class="preprocessor">#ifdef Q_OS_ANDROID</span>
      <span class="keyword">if</span> (<span class="type">QtAndroid</span><span class="operator">::</span>androidSdkVersion() <span class="operator">&gt;</span><span class="operator">=</span> <span class="number">23</span>)
          remoteSelector<span class="operator">.</span>startDiscovery(<span class="type"><a href="qbluetoothuuid.html">QBluetoothUuid</a></span>(reverseUuid));
      <span class="keyword">else</span>
          remoteSelector<span class="operator">.</span>startDiscovery(<span class="type"><a href="qbluetoothuuid.html">QBluetoothUuid</a></span>(serviceUuid));
  <span class="preprocessor">#else</span>
      remoteSelector<span class="operator">.</span>startDiscovery(<span class="type"><a href="qbluetoothuuid.html">QBluetoothUuid</a></span>(serviceUuid));
  <span class="preprocessor">#endif</span>
      <span class="keyword">if</span> (remoteSelector<span class="operator">.</span>exec() <span class="operator">=</span><span class="operator">=</span> <span class="type">QDialog</span><span class="operator">::</span>Accepted) {
          <span class="type"><a href="qbluetoothserviceinfo.html">QBluetoothServiceInfo</a></span> service <span class="operator">=</span> remoteSelector<span class="operator">.</span>service();

          <a href="../qtcore/qtglobal.html#qDebug">qDebug</a>() <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="string">&quot;Connecting to service 2&quot;</span> <span class="operator">&lt;</span><span class="operator">&lt;</span> service<span class="operator">.</span>serviceName()
                   <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="string">&quot;on&quot;</span> <span class="operator">&lt;</span><span class="operator">&lt;</span> service<span class="operator">.</span>device()<span class="operator">.</span>name();

          <span class="comment">// Create client</span>
          <a href="../qtcore/qtglobal.html#qDebug">qDebug</a>() <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="string">&quot;Going to create client&quot;</span>;
          ChatClient <span class="operator">*</span>client <span class="operator">=</span> <span class="keyword">new</span> ChatClient(<span class="keyword">this</span>);
  <a href="../qtcore/qtglobal.html#qDebug">qDebug</a>() <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="string">&quot;Connecting...&quot;</span>;

          connect(client<span class="operator">,</span> <span class="operator">&amp;</span>ChatClient<span class="operator">::</span>messageReceived<span class="operator">,</span>
                  <span class="keyword">this</span><span class="operator">,</span> <span class="operator">&amp;</span>Chat<span class="operator">::</span>showMessage);
          connect(client<span class="operator">,</span> <span class="operator">&amp;</span>ChatClient<span class="operator">::</span>disconnected<span class="operator">,</span>
                  <span class="keyword">this</span><span class="operator">,</span> <span class="type">QOverload</span><span class="operator">&lt;</span><span class="operator">&gt;</span><span class="operator">::</span>of(<span class="operator">&amp;</span>Chat<span class="operator">::</span>clientDisconnected));
          connect(client<span class="operator">,</span> <span class="type">QOverload</span><span class="operator">&lt;</span><span class="keyword">const</span> <span class="type"><a href="../qtcore/qstring.html">QString</a></span> <span class="operator">&amp;</span><span class="operator">&gt;</span><span class="operator">::</span>of(<span class="operator">&amp;</span>ChatClient<span class="operator">::</span>connected)<span class="operator">,</span>
                  <span class="keyword">this</span><span class="operator">,</span> <span class="operator">&amp;</span>Chat<span class="operator">::</span>connected);
          connect(client<span class="operator">,</span> <span class="operator">&amp;</span>ChatClient<span class="operator">::</span>socketErrorOccurred<span class="operator">,</span>
                  <span class="keyword">this</span><span class="operator">,</span> <span class="operator">&amp;</span>Chat<span class="operator">::</span>reactOnSocketError);
          connect(<span class="keyword">this</span><span class="operator">,</span> <span class="operator">&amp;</span>Chat<span class="operator">::</span>sendMessage<span class="operator">,</span> client<span class="operator">,</span> <span class="operator">&amp;</span>ChatClient<span class="operator">::</span>sendMessage);
  <a href="../qtcore/qtglobal.html#qDebug">qDebug</a>() <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="string">&quot;Start client&quot;</span>;
          client<span class="operator">-</span><span class="operator">&gt;</span>startClient(service);

          clients<span class="operator">.</span>append(client);
      }

      ui<span class="operator">-</span><span class="operator">&gt;</span>connectButton<span class="operator">-</span><span class="operator">&gt;</span>setEnabled(<span class="keyword">true</span>);
  }

</pre>
<p>In reponse to the connected() signals from ChatClient, we display the a &quot;Joined chat with X.&quot; message in the chat session.</p>
<pre class="cpp">

  <span class="type">void</span> Chat<span class="operator">::</span>connected(<span class="keyword">const</span> <span class="type"><a href="../qtcore/qstring.html">QString</a></span> <span class="operator">&amp;</span>name)
  {
      ui<span class="operator">-</span><span class="operator">&gt;</span>chat<span class="operator">-</span><span class="operator">&gt;</span>insertPlainText(<span class="type"><a href="../qtcore/qstring.html">QString</a></span><span class="operator">::</span>fromLatin1(<span class="string">&quot;Joined chat with %1.\n&quot;</span>)<span class="operator">.</span>arg(name));
  }

</pre>
<p>Messages are sent to all remote devices via the ChatServer and ChatClient instances by emitting the sendMessage() signal.</p>
<pre class="cpp">

  <span class="type">void</span> Chat<span class="operator">::</span>sendClicked()
  {
      ui<span class="operator">-</span><span class="operator">&gt;</span>sendButton<span class="operator">-</span><span class="operator">&gt;</span>setEnabled(<span class="keyword">false</span>);
      ui<span class="operator">-</span><span class="operator">&gt;</span>sendText<span class="operator">-</span><span class="operator">&gt;</span>setEnabled(<span class="keyword">false</span>);

      showMessage(localName<span class="operator">,</span> ui<span class="operator">-</span><span class="operator">&gt;</span>sendText<span class="operator">-</span><span class="operator">&gt;</span>text());
      <span class="keyword">emit</span> sendMessage(ui<span class="operator">-</span><span class="operator">&gt;</span>sendText<span class="operator">-</span><span class="operator">&gt;</span>text());

      ui<span class="operator">-</span><span class="operator">&gt;</span>sendText<span class="operator">-</span><span class="operator">&gt;</span>clear();

      ui<span class="operator">-</span><span class="operator">&gt;</span>sendText<span class="operator">-</span><span class="operator">&gt;</span>setEnabled(<span class="keyword">true</span>);
      ui<span class="operator">-</span><span class="operator">&gt;</span>sendButton<span class="operator">-</span><span class="operator">&gt;</span>setEnabled(<span class="keyword">true</span>);
  }

</pre>
<p>We need to clean up ChatClient instances when the remote device forces a disconnect.</p>
<pre class="cpp">

  <span class="type">void</span> Chat<span class="operator">::</span>clientDisconnected()
  {
      ChatClient <span class="operator">*</span>client <span class="operator">=</span> qobject_cast<span class="operator">&lt;</span>ChatClient <span class="operator">*</span><span class="operator">&gt;</span>(sender());
      <span class="keyword">if</span> (client) {
          clients<span class="operator">.</span>removeOne(client);
          client<span class="operator">-</span><span class="operator">&gt;</span>deleteLater();
      }
  }

</pre>
<p>文件：</p>
<ul>
<li><a href="qtbluetooth-btchat-btchat-pro.html">btchat/btchat.pro</a></li>
<li><a href="qtbluetooth-btchat-chat-cpp.html">btchat/chat.cpp</a></li>
<li><a href="qtbluetooth-btchat-chat-h.html">btchat/chat.h</a></li>
<li><a href="qtbluetooth-btchat-chat-ui.html">btchat/chat.ui</a></li>
<li><a href="qtbluetooth-btchat-chatclient-cpp.html">btchat/chatclient.cpp</a></li>
<li><a href="qtbluetooth-btchat-chatclient-h.html">btchat/chatclient.h</a></li>
<li><a href="qtbluetooth-btchat-chatserver-cpp.html">btchat/chatserver.cpp</a></li>
<li><a href="qtbluetooth-btchat-chatserver-h.html">btchat/chatserver.h</a></li>
<li><a href="qtbluetooth-btchat-main-cpp.html">btchat/main.cpp</a></li>
<li><a href="qtbluetooth-btchat-remoteselector-cpp.html">btchat/remoteselector.cpp</a></li>
<li><a href="qtbluetooth-btchat-remoteselector-h.html">btchat/remoteselector.h</a></li>
<li><a href="qtbluetooth-btchat-remoteselector-ui.html">btchat/remoteselector.ui</a></li>
</ul>
</div>
<!-- @@@btchat -->
        </div>
       </div>
   </div>
   </div>
</div>
<div class="footer">
   <p>
   <acronym title="Copyright">&copy;</acronym> 2018 The Qt Company Ltd.
   Documentation contributions included herein are the copyrights of
   their respective owners.<br/>    The documentation provided herein is licensed under the terms of the    <a href="http://www.gnu.org/licenses/fdl.html">GNU Free Documentation    License version 1.3</a> as published by the Free Software Foundation.<br/>    Qt and respective logos are trademarks of The Qt Company Ltd.     in Finland and/or other countries worldwide. All other trademarks are property
   of their respective owners. </p>
</div>
</body>
</html>
