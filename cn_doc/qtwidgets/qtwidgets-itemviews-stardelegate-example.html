<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<!-- stardelegate.qdoc -->
  <title>Star Delegate Example | Qt Widgets 5.12</title>
  <link rel="stylesheet" type="text/css" href="style/offline-simple.css" />
  <script type="text/javascript">
    document.getElementsByTagName("link").item(0).setAttribute("href", "style/offline.css");
    // loading style sheet breaks anchors that were jumped to before
    // so force jumping to anchor again
    setTimeout(function() {
        var anchor = location.hash;
        // need to jump to different anchor first (e.g. none)
        location.hash = "#";
        setTimeout(function() {
            location.hash = anchor;
        }, 0);
    }, 0);
  </script>
</head>
<body>
<div class="header" id="qtdocheader">
  <div class="main">
    <div class="main-rounded">
      <div class="navigationbar">
        <table><tr>
<td ><a href="../qtdoc/index.html">Qt 5.12</a></td><td ><a href="qtwidgets-index.html">Qt部件</a></td><td ><a href="examples-itemviews.html">Item Views Examples</a></td><td >Star Delegate Example</td></tr></table><table class="buildversion"><tr>
<td id="buildversion" width="100%" align="right">Qt5.12.0参考文档</td>
        </tr></table>
      </div>
    </div>
<div class="content">
<div class="line">
<div class="content mainContent">
<div class="sidebar">
<div class="toc">
<h3><a name="toc">目录</a></h3>
<ul>
<li class="level1"><a href="#stardelegate-class-definition">StarDelegate Class Definition</a></li>
<li class="level1"><a href="#stardelegate-class-implementation">StarDelegate Class Implementation</a></li>
<li class="level1"><a href="#stareditor-class-definition">StarEditor Class Definition</a></li>
<li class="level1"><a href="#stareditor-class-implementation">StarEditor Class Implementation</a></li>
<li class="level1"><a href="#starrating-class-definition">StarRating Class Definition</a></li>
<li class="level1"><a href="#starrating-class-implementation">StarRating Class Implementation</a></li>
<li class="level1"><a href="#the-main-function">The <code>main()</code> Function</a></li>
<li class="level1"><a href="#possible-extensions-and-suggestions">Possible Extensions and Suggestions</a></li>
</ul>
</div>
<div class="sidebar-content" id="sidebar-content"></div></div>
<h1 class="title">Star Delegate Example</h1>
<span class="subtitle"></span>
<!-- $$$itemviews/stardelegate-brief -->
<p>The Star Delegate example shows how to create a delegate that can paint itself and that supports editing.</p>
<!-- @@@itemviews/stardelegate -->
<!-- $$$itemviews/stardelegate-description -->
<div class="descr"> <a name="details"></a>
<p class="centerAlign"><img src="images/stardelegate.png" alt="The Star Delegate Example" /></p><p>When displaying data in a <a href="qlistview.html">QListView</a>, <a href="qtableview.html">QTableView</a>, or <a href="qtreeview.html">QTreeView</a>, the individual items are drawn by a <a href="model-view-programming.html#delegate-classes">delegate</a>. Also, when the user starts editing an item (for example, by double-clicking the item), the delegate provides an editor widget that is placed on top of the item while editing takes place.</p>
<p>Delegates are subclasses of <a href="qabstractitemdelegate.html">QAbstractItemDelegate</a>. Qt provides <a href="qitemdelegate.html">QItemDelegate</a>, which inherits <a href="qabstractitemdelegate.html">QAbstractItemDelegate</a> and handles the most common data types (notably <code>int</code> and <a href="../qtcore/qstring.html">QString</a>). If we need to support custom data types, or want to customize the rendering or the editing for existing data types, we can subclass <a href="qabstractitemdelegate.html">QAbstractItemDelegate</a> or <a href="qitemdelegate.html">QItemDelegate</a>. See <a href="model-view-programming.html#delegate-classes">Delegate Classes</a> for more information about delegates, and <a href="model-view-programming.html">Model/View Programming</a> if you need a high-level introduction to Qt's model/view architecture (including delegates).</p>
<p>In this example, we will see how to implement a custom delegate to render and edit a &quot;star rating&quot; data type, which can store values such as &quot;1 out of 5 stars&quot;.</p>
<p>The example consists of the following classes:</p>
<ul>
<li><code>StarRating</code> is the custom data type. It stores a rating expressed as stars, such as &quot;2 out of 5 stars&quot; or &quot;5 out of 6 stars&quot;.</li>
<li><code>StarDelegate</code> inherits <a href="qitemdelegate.html">QItemDelegate</a> and provides support for <code>StarRating</code> (in addition to the data types already handled by <a href="qitemdelegate.html">QItemDelegate</a>).</li>
<li><code>StarEditor</code> inherits <a href="qwidget.html">QWidget</a> and is used by <code>StarDelegate</code> to let the user edit a star rating using the mouse.</li>
</ul>
<p>To show the <code>StarDelegate</code> in action, we will fill a <a href="qtablewidget.html">QTableWidget</a> with some data and install the delegate on it.</p>
<a name="stardelegate-class-definition"></a>
<h2 id="stardelegate-class-definition">StarDelegate Class Definition</h2>
<p>Here's the definition of the <code>StarDelegate</code> class:</p>
<pre class="cpp">

  <span class="keyword">class</span> StarDelegate : <span class="keyword">public</span> <span class="type"><a href="qstyleditemdelegate.html">QStyledItemDelegate</a></span>
  {
      Q_OBJECT

  <span class="keyword">public</span>:
      StarDelegate(<span class="type"><a href="qwidget.html">QWidget</a></span> <span class="operator">*</span>parent <span class="operator">=</span> <span class="number">0</span>) : <span class="type"><a href="qstyleditemdelegate.html">QStyledItemDelegate</a></span>(parent) {}

      <span class="type">void</span> paint(<span class="type"><a href="../qtgui/qpainter.html">QPainter</a></span> <span class="operator">*</span>painter<span class="operator">,</span> <span class="keyword">const</span> <span class="type"><a href="qstyleoptionviewitem.html">QStyleOptionViewItem</a></span> <span class="operator">&amp;</span>option<span class="operator">,</span>
                 <span class="keyword">const</span> <span class="type"><a href="../qtcore/qmodelindex.html">QModelIndex</a></span> <span class="operator">&amp;</span>index) <span class="keyword">const</span> override;
      <span class="type"><a href="../qtcore/qsize.html">QSize</a></span> sizeHint(<span class="keyword">const</span> <span class="type"><a href="qstyleoptionviewitem.html">QStyleOptionViewItem</a></span> <span class="operator">&amp;</span>option<span class="operator">,</span>
                     <span class="keyword">const</span> <span class="type"><a href="../qtcore/qmodelindex.html">QModelIndex</a></span> <span class="operator">&amp;</span>index) <span class="keyword">const</span> override;
      <span class="type"><a href="qwidget.html">QWidget</a></span> <span class="operator">*</span>createEditor(<span class="type"><a href="qwidget.html">QWidget</a></span> <span class="operator">*</span>parent<span class="operator">,</span> <span class="keyword">const</span> <span class="type"><a href="qstyleoptionviewitem.html">QStyleOptionViewItem</a></span> <span class="operator">&amp;</span>option<span class="operator">,</span>
                            <span class="keyword">const</span> <span class="type"><a href="../qtcore/qmodelindex.html">QModelIndex</a></span> <span class="operator">&amp;</span>index) <span class="keyword">const</span> override;
      <span class="type">void</span> setEditorData(<span class="type"><a href="qwidget.html">QWidget</a></span> <span class="operator">*</span>editor<span class="operator">,</span> <span class="keyword">const</span> <span class="type"><a href="../qtcore/qmodelindex.html">QModelIndex</a></span> <span class="operator">&amp;</span>index) <span class="keyword">const</span> override;
      <span class="type">void</span> setModelData(<span class="type"><a href="qwidget.html">QWidget</a></span> <span class="operator">*</span>editor<span class="operator">,</span> <span class="type"><a href="../qtcore/qabstractitemmodel.html">QAbstractItemModel</a></span> <span class="operator">*</span>model<span class="operator">,</span>
                        <span class="keyword">const</span> <span class="type"><a href="../qtcore/qmodelindex.html">QModelIndex</a></span> <span class="operator">&amp;</span>index) <span class="keyword">const</span> override;

  <span class="keyword">private</span> <span class="keyword">slots</span>:
      <span class="type">void</span> commitAndCloseEditor();
  };

</pre>
<p>All public functions are reimplemented virtual functions from <a href="qitemdelegate.html">QItemDelegate</a> to provide custom rendering and editing.</p>
<a name="stardelegate-class-implementation"></a>
<h2 id="stardelegate-class-implementation">StarDelegate Class Implementation</h2>
<p>The <a href="qabstractitemdelegate.html#paint">paint()</a> function is reimplemented from <a href="qitemdelegate.html">QItemDelegate</a> and is called whenever the view needs to repaint an item:</p>
<pre class="cpp">

  <span class="type">void</span> StarDelegate<span class="operator">::</span>paint(<span class="type"><a href="../qtgui/qpainter.html">QPainter</a></span> <span class="operator">*</span>painter<span class="operator">,</span> <span class="keyword">const</span> <span class="type"><a href="qstyleoptionviewitem.html">QStyleOptionViewItem</a></span> <span class="operator">&amp;</span>option<span class="operator">,</span>
                           <span class="keyword">const</span> <span class="type"><a href="../qtcore/qmodelindex.html">QModelIndex</a></span> <span class="operator">&amp;</span>index) <span class="keyword">const</span>
  {
      <span class="keyword">if</span> (index<span class="operator">.</span>data()<span class="operator">.</span>canConvert<span class="operator">&lt;</span>StarRating<span class="operator">&gt;</span>()) {
          StarRating starRating <span class="operator">=</span> qvariant_cast<span class="operator">&lt;</span>StarRating<span class="operator">&gt;</span>(index<span class="operator">.</span>data());

          <span class="keyword">if</span> (option<span class="operator">.</span>state <span class="operator">&amp;</span> <span class="type"><a href="qstyle.html">QStyle</a></span><span class="operator">::</span>State_Selected)
              painter<span class="operator">-</span><span class="operator">&gt;</span>fillRect(option<span class="operator">.</span>rect<span class="operator">,</span> option<span class="operator">.</span>palette<span class="operator">.</span>highlight());

          starRating<span class="operator">.</span>paint(painter<span class="operator">,</span> option<span class="operator">.</span>rect<span class="operator">,</span> option<span class="operator">.</span>palette<span class="operator">,</span>
                           StarRating<span class="operator">::</span>ReadOnly);
      } <span class="keyword">else</span> {
          <span class="type"><a href="qstyleditemdelegate.html">QStyledItemDelegate</a></span><span class="operator">::</span>paint(painter<span class="operator">,</span> option<span class="operator">,</span> index);
      }

</pre>
<p>The function is invoked once for each item, represented by a <a href="../qtcore/qmodelindex.html">QModelIndex</a> object from the model. If the data stored in the item is a <code>StarRating</code>, we paint it ourselves; otherwise, we let <a href="qitemdelegate.html">QItemDelegate</a> paint it for us. This ensures that the <code>StarDelegate</code> can handle the most common data types.</p>
<p>If the item is a <code>StarRating</code>, we draw the background if the item is selected, and we draw the item using <code>StarRating::paint()</code>, which we will review later.</p>
<p><code>StartRating</code>s can be stored in a <a href="../qtcore/qvariant.html">QVariant</a> thanks to the <a href="../qtcore/qmetatype.html#Q_DECLARE_METATYPE">Q_DECLARE_METATYPE</a>() macro appearing in <code>starrating.h</code>. More on this later.</p>
<p>The <a href="qabstractitemdelegate.html#createEditor">createEditor()</a> function is called when the user starts editing an item:</p>
<pre class="cpp">

  <span class="type"><a href="qwidget.html">QWidget</a></span> <span class="operator">*</span>StarDelegate<span class="operator">::</span>createEditor(<span class="type"><a href="qwidget.html">QWidget</a></span> <span class="operator">*</span>parent<span class="operator">,</span>
                                      <span class="keyword">const</span> <span class="type"><a href="qstyleoptionviewitem.html">QStyleOptionViewItem</a></span> <span class="operator">&amp;</span>option<span class="operator">,</span>
                                      <span class="keyword">const</span> <span class="type"><a href="../qtcore/qmodelindex.html">QModelIndex</a></span> <span class="operator">&amp;</span>index) <span class="keyword">const</span>

  {
      <span class="keyword">if</span> (index<span class="operator">.</span>data()<span class="operator">.</span>canConvert<span class="operator">&lt;</span>StarRating<span class="operator">&gt;</span>()) {
          StarEditor <span class="operator">*</span>editor <span class="operator">=</span> <span class="keyword">new</span> StarEditor(parent);
          connect(editor<span class="operator">,</span> <span class="operator">&amp;</span>StarEditor<span class="operator">::</span>editingFinished<span class="operator">,</span>
                  <span class="keyword">this</span><span class="operator">,</span> <span class="operator">&amp;</span>StarDelegate<span class="operator">::</span>commitAndCloseEditor);
          <span class="keyword">return</span> editor;
      } <span class="keyword">else</span> {
          <span class="keyword">return</span> <span class="type"><a href="qstyleditemdelegate.html">QStyledItemDelegate</a></span><span class="operator">::</span>createEditor(parent<span class="operator">,</span> option<span class="operator">,</span> index);
      }
  }

</pre>
<p>If the item is a <code>StarRating</code>, we create a <code>StarEditor</code> and connect its <code>editingFinished()</code> signal to our <code>commitAndCloseEditor()</code> slot, so we can update the model when the editor closes.</p>
<p>Here's the implementation of <code>commitAndCloseEditor()</code>:</p>
<pre class="cpp">

  <span class="type">void</span> StarDelegate<span class="operator">::</span>commitAndCloseEditor()
  {
      StarEditor <span class="operator">*</span>editor <span class="operator">=</span> qobject_cast<span class="operator">&lt;</span>StarEditor <span class="operator">*</span><span class="operator">&gt;</span>(sender());
      <span class="keyword">emit</span> commitData(editor);
      <span class="keyword">emit</span> closeEditor(editor);
  }

</pre>
<p>When the user is done editing, we emit <a href="qabstractitemdelegate.html#commitData">commitData()</a> 和 <a href="qabstractitemdelegate.html#closeEditor">closeEditor()</a> (both declared in <a href="qabstractitemdelegate.html">QAbstractItemDelegate</a>), to tell the model that there is edited data and to inform the view that the editor is no longer needed.</p>
<p>The <a href="qabstractitemdelegate.html#setEditorData">setEditorData()</a> function is called when an editor is created to initialize it with data from the model:</p>
<pre class="cpp">

  <span class="type">void</span> StarDelegate<span class="operator">::</span>setEditorData(<span class="type"><a href="qwidget.html">QWidget</a></span> <span class="operator">*</span>editor<span class="operator">,</span>
                                   <span class="keyword">const</span> <span class="type"><a href="../qtcore/qmodelindex.html">QModelIndex</a></span> <span class="operator">&amp;</span>index) <span class="keyword">const</span>
  {
      <span class="keyword">if</span> (index<span class="operator">.</span>data()<span class="operator">.</span>canConvert<span class="operator">&lt;</span>StarRating<span class="operator">&gt;</span>()) {
          StarRating starRating <span class="operator">=</span> qvariant_cast<span class="operator">&lt;</span>StarRating<span class="operator">&gt;</span>(index<span class="operator">.</span>data());
          StarEditor <span class="operator">*</span>starEditor <span class="operator">=</span> qobject_cast<span class="operator">&lt;</span>StarEditor <span class="operator">*</span><span class="operator">&gt;</span>(editor);
          starEditor<span class="operator">-</span><span class="operator">&gt;</span>setStarRating(starRating);
      } <span class="keyword">else</span> {
          <span class="type"><a href="qstyleditemdelegate.html">QStyledItemDelegate</a></span><span class="operator">::</span>setEditorData(editor<span class="operator">,</span> index);
      }
  }

</pre>
<p>We simply call <code>setStarRating()</code> on the editor.</p>
<p>The <a href="qabstractitemdelegate.html#setModelData">setModelData()</a> function is called to commit data from the editor to the model when editing is finished:</p>
<pre class="cpp">

  <span class="type">void</span> StarDelegate<span class="operator">::</span>setModelData(<span class="type"><a href="qwidget.html">QWidget</a></span> <span class="operator">*</span>editor<span class="operator">,</span> <span class="type"><a href="../qtcore/qabstractitemmodel.html">QAbstractItemModel</a></span> <span class="operator">*</span>model<span class="operator">,</span>
                                  <span class="keyword">const</span> <span class="type"><a href="../qtcore/qmodelindex.html">QModelIndex</a></span> <span class="operator">&amp;</span>index) <span class="keyword">const</span>
  {
      <span class="keyword">if</span> (index<span class="operator">.</span>data()<span class="operator">.</span>canConvert<span class="operator">&lt;</span>StarRating<span class="operator">&gt;</span>()) {
          StarEditor <span class="operator">*</span>starEditor <span class="operator">=</span> qobject_cast<span class="operator">&lt;</span>StarEditor <span class="operator">*</span><span class="operator">&gt;</span>(editor);
          model<span class="operator">-</span><span class="operator">&gt;</span>setData(index<span class="operator">,</span> <span class="type"><a href="../qtcore/qvariant.html">QVariant</a></span><span class="operator">::</span>fromValue(starEditor<span class="operator">-</span><span class="operator">&gt;</span>starRating()));
      } <span class="keyword">else</span> {
          <span class="type"><a href="qstyleditemdelegate.html">QStyledItemDelegate</a></span><span class="operator">::</span>setModelData(editor<span class="operator">,</span> model<span class="operator">,</span> index);
      }
  }

</pre>
<p>The <code>sizeHint()</code> function returns an item's preferred size:</p>
<pre class="cpp">

  <span class="type"><a href="../qtcore/qsize.html">QSize</a></span> StarDelegate<span class="operator">::</span>sizeHint(<span class="keyword">const</span> <span class="type"><a href="qstyleoptionviewitem.html">QStyleOptionViewItem</a></span> <span class="operator">&amp;</span>option<span class="operator">,</span>
                               <span class="keyword">const</span> <span class="type"><a href="../qtcore/qmodelindex.html">QModelIndex</a></span> <span class="operator">&amp;</span>index) <span class="keyword">const</span>
  {
      <span class="keyword">if</span> (index<span class="operator">.</span>data()<span class="operator">.</span>canConvert<span class="operator">&lt;</span>StarRating<span class="operator">&gt;</span>()) {
          StarRating starRating <span class="operator">=</span> qvariant_cast<span class="operator">&lt;</span>StarRating<span class="operator">&gt;</span>(index<span class="operator">.</span>data());
          <span class="keyword">return</span> starRating<span class="operator">.</span>sizeHint();
      } <span class="keyword">else</span> {
          <span class="keyword">return</span> <span class="type"><a href="qstyleditemdelegate.html">QStyledItemDelegate</a></span><span class="operator">::</span>sizeHint(option<span class="operator">,</span> index);
      }
  }

</pre>
<p>We simply forward the call to <code>StarRating</code>.</p>
<a name="stareditor-class-definition"></a>
<h2 id="stareditor-class-definition">StarEditor Class Definition</h2>
<p>The <code>StarEditor</code> class was used when implementing <code>StarDelegate</code>. Here's the class definition:</p>
<pre class="cpp">

  <span class="keyword">class</span> StarEditor : <span class="keyword">public</span> <span class="type"><a href="qwidget.html">QWidget</a></span>
  {
      Q_OBJECT

  <span class="keyword">public</span>:
      StarEditor(<span class="type"><a href="qwidget.html">QWidget</a></span> <span class="operator">*</span>parent <span class="operator">=</span> <span class="number">0</span>);

      <span class="type"><a href="../qtcore/qsize.html">QSize</a></span> sizeHint() <span class="keyword">const</span> override;
      <span class="type">void</span> setStarRating(<span class="keyword">const</span> StarRating <span class="operator">&amp;</span>starRating) {
          myStarRating <span class="operator">=</span> starRating;
      }
      StarRating starRating() { <span class="keyword">return</span> myStarRating; }

  <span class="keyword">signals</span>:
      <span class="type">void</span> editingFinished();

  <span class="keyword">protected</span>:
      <span class="type">void</span> paintEvent(<span class="type"><a href="../qtgui/qpaintevent.html">QPaintEvent</a></span> <span class="operator">*</span>event) override;
      <span class="type">void</span> mouseMoveEvent(<span class="type"><a href="../qtgui/qmouseevent.html">QMouseEvent</a></span> <span class="operator">*</span>event) override;
      <span class="type">void</span> mouseReleaseEvent(<span class="type"><a href="../qtgui/qmouseevent.html">QMouseEvent</a></span> <span class="operator">*</span>event) override;

  <span class="keyword">private</span>:
      <span class="type">int</span> starAtPosition(<span class="type">int</span> x);

      StarRating myStarRating;
  };

</pre>
<p>The class lets the user edit a <code>StarRating</code> by moving the mouse over the editor. It emits the <code>editingFinished()</code> signal when the user clicks on the editor.</p>
<p>The protected functions are reimplemented from <a href="qwidget.html">QWidget</a> to handle mouse and paint events. The private function <code>starAtPosition()</code> is a helper function that returns the number of the star under the mouse pointer.</p>
<a name="stareditor-class-implementation"></a>
<h2 id="stareditor-class-implementation">StarEditor Class Implementation</h2>
<p>Let's start with the constructor:</p>
<pre class="cpp">

  StarEditor<span class="operator">::</span>StarEditor(<span class="type"><a href="qwidget.html">QWidget</a></span> <span class="operator">*</span>parent)
      : <span class="type"><a href="qwidget.html">QWidget</a></span>(parent)
  {
      setMouseTracking(<span class="keyword">true</span>);
      setAutoFillBackground(<span class="keyword">true</span>);
  }

</pre>
<p>We enable <a href="qwidget.html#mouseTracking-prop">mouse tracking</a> on the widget so we can follow the cursor even when the user doesn't hold down any mouse button. We also turn on <a href="qwidget.html">QWidget</a>'s <a href="qwidget.html#autoFillBackground-prop">auto-fill background</a> feature to obtain an opaque background. (Without the call, the view's background would shine through the editor.)</p>
<p>The <a href="qwidget.html#paintEvent">paintEvent()</a> function is reimplemented from <a href="qwidget.html">QWidget</a>:</p>
<pre class="cpp">

  <span class="type">void</span> StarEditor<span class="operator">::</span>paintEvent(<span class="type"><a href="../qtgui/qpaintevent.html">QPaintEvent</a></span> <span class="operator">*</span>)
  {
      <span class="type"><a href="../qtgui/qpainter.html">QPainter</a></span> painter(<span class="keyword">this</span>);
      myStarRating<span class="operator">.</span>paint(<span class="operator">&amp;</span>painter<span class="operator">,</span> rect()<span class="operator">,</span> <span class="keyword">this</span><span class="operator">-</span><span class="operator">&gt;</span>palette()<span class="operator">,</span>
                         StarRating<span class="operator">::</span>Editable);
  }

</pre>
<p>We simply call <code>StarRating::paint()</code> to draw the stars, just like we did when implementing <code>StarDelegate</code>.</p>
<pre class="cpp">

  <span class="type">void</span> StarEditor<span class="operator">::</span>mouseMoveEvent(<span class="type"><a href="../qtgui/qmouseevent.html">QMouseEvent</a></span> <span class="operator">*</span>event)
  {
      <span class="type">int</span> star <span class="operator">=</span> starAtPosition(event<span class="operator">-</span><span class="operator">&gt;</span>x());

      <span class="keyword">if</span> (star <span class="operator">!</span><span class="operator">=</span> myStarRating<span class="operator">.</span>starCount() <span class="operator">&amp;</span><span class="operator">&amp;</span> star <span class="operator">!</span><span class="operator">=</span> <span class="operator">-</span><span class="number">1</span>) {
          myStarRating<span class="operator">.</span>setStarCount(star);
          update();
      }
  }

</pre>
<p>In the mouse event handler, we call <code>setStarCount()</code> on the private data member <code>myStarRating</code> to reflect the current cursor position, and we call <a href="qwidget.html#update">QWidget::update</a>() to force a repaint.</p>
<pre class="cpp">

  <span class="type">void</span> StarEditor<span class="operator">::</span>mouseReleaseEvent(<span class="type"><a href="../qtgui/qmouseevent.html">QMouseEvent</a></span> <span class="operator">*</span> <span class="comment">/* event */</span>)
  {
      <span class="keyword">emit</span> editingFinished();
  }

</pre>
<p>When the user releases a mouse button, we simply emit the <code>editingFinished()</code> signal.</p>
<pre class="cpp">

  <span class="type">int</span> StarEditor<span class="operator">::</span>starAtPosition(<span class="type">int</span> x)
  {
      <span class="type">int</span> star <span class="operator">=</span> (x <span class="operator">/</span> (myStarRating<span class="operator">.</span>sizeHint()<span class="operator">.</span>width()
                       <span class="operator">/</span> myStarRating<span class="operator">.</span>maxStarCount())) <span class="operator">+</span> <span class="number">1</span>;
      <span class="keyword">if</span> (star <span class="operator">&lt;</span><span class="operator">=</span> <span class="number">0</span> <span class="operator">|</span><span class="operator">|</span> star <span class="operator">&gt;</span> myStarRating<span class="operator">.</span>maxStarCount())
          <span class="keyword">return</span> <span class="operator">-</span><span class="number">1</span>;

      <span class="keyword">return</span> star;
  }

</pre>
<p>The <code>starAtPosition()</code> function uses basic linear algebra to find out which star is under the cursor.</p>
<a name="starrating-class-definition"></a>
<h2 id="starrating-class-definition">StarRating Class Definition</h2>
<pre class="cpp">

  <span class="keyword">class</span> StarRating
  {
  <span class="keyword">public</span>:
      <span class="keyword">enum</span> EditMode { Editable<span class="operator">,</span> ReadOnly };

      <span class="keyword">explicit</span> StarRating(<span class="type">int</span> starCount <span class="operator">=</span> <span class="number">1</span><span class="operator">,</span> <span class="type">int</span> maxStarCount <span class="operator">=</span> <span class="number">5</span>);

      <span class="type">void</span> paint(<span class="type"><a href="../qtgui/qpainter.html">QPainter</a></span> <span class="operator">*</span>painter<span class="operator">,</span> <span class="keyword">const</span> <span class="type"><a href="../qtcore/qrect.html">QRect</a></span> <span class="operator">&amp;</span>rect<span class="operator">,</span>
                 <span class="keyword">const</span> <span class="type"><a href="../qtgui/qpalette.html">QPalette</a></span> <span class="operator">&amp;</span>palette<span class="operator">,</span> EditMode mode) <span class="keyword">const</span>;
      <span class="type"><a href="../qtcore/qsize.html">QSize</a></span> sizeHint() <span class="keyword">const</span>;
      <span class="type">int</span> starCount() <span class="keyword">const</span> { <span class="keyword">return</span> myStarCount; }
      <span class="type">int</span> maxStarCount() <span class="keyword">const</span> { <span class="keyword">return</span> myMaxStarCount; }
      <span class="type">void</span> setStarCount(<span class="type">int</span> starCount) { myStarCount <span class="operator">=</span> starCount; }
      <span class="type">void</span> setMaxStarCount(<span class="type">int</span> maxStarCount) { myMaxStarCount <span class="operator">=</span> maxStarCount; }

  <span class="keyword">private</span>:
      <span class="type"><a href="../qtgui/qpolygonf.html">QPolygonF</a></span> starPolygon;
      <span class="type"><a href="../qtgui/qpolygonf.html">QPolygonF</a></span> diamondPolygon;
      <span class="type">int</span> myStarCount;
      <span class="type">int</span> myMaxStarCount;
  };

  Q_DECLARE_METATYPE(StarRating)

</pre>
<p>The <code>StarRating</code> class represents a rating as a number of stars. In addition to holding the data, it is also capable of painting the stars on a <a href="../qtgui/qpaintdevice.html">QPaintDevice</a>, which in this example is either a view or an editor. The <code>myStarCount</code> member variable stores the current rating, and <code>myMaxStarCount</code> stores the highest possible rating (typically 5).</p>
<p>The <code>Q_DECLARE_METATYPE()</code> macro makes the type <code>StarRating</code> known to <a href="../qtcore/qvariant.html">QVariant</a>, making it possible to store <code>StarRating</code> values in <a href="../qtcore/qvariant.html">QVariant</a>.</p>
<a name="starrating-class-implementation"></a>
<h2 id="starrating-class-implementation">StarRating Class Implementation</h2>
<p>The constructor initializes <code>myStarCount</code> and <code>myMaxStarCount</code>, and sets up the polygons used to draw stars and diamonds:</p>
<pre class="cpp">

  StarRating<span class="operator">::</span>StarRating(<span class="type">int</span> starCount<span class="operator">,</span> <span class="type">int</span> maxStarCount)
  {
      myStarCount <span class="operator">=</span> starCount;
      myMaxStarCount <span class="operator">=</span> maxStarCount;

      starPolygon <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="../qtcore/qpointf.html">QPointF</a></span>(<span class="number">1.0</span><span class="operator">,</span> <span class="number">0.5</span>);
      <span class="keyword">for</span> (<span class="type">int</span> i <span class="operator">=</span> <span class="number">1</span>; i <span class="operator">&lt;</span> <span class="number">5</span>; <span class="operator">+</span><span class="operator">+</span>i)
          starPolygon <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="../qtcore/qpointf.html">QPointF</a></span>(<span class="number">0.5</span> <span class="operator">+</span> <span class="number">0.5</span> <span class="operator">*</span> std<span class="operator">::</span>cos(<span class="number">0.8</span> <span class="operator">*</span> i <span class="operator">*</span> <span class="number">3.14</span>)<span class="operator">,</span>
                                 <span class="number">0.5</span> <span class="operator">+</span> <span class="number">0.5</span> <span class="operator">*</span> std<span class="operator">::</span>sin(<span class="number">0.8</span> <span class="operator">*</span> i <span class="operator">*</span> <span class="number">3.14</span>));

      diamondPolygon <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="../qtcore/qpointf.html">QPointF</a></span>(<span class="number">0.4</span><span class="operator">,</span> <span class="number">0.5</span>) <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="../qtcore/qpointf.html">QPointF</a></span>(<span class="number">0.5</span><span class="operator">,</span> <span class="number">0.4</span>)
                     <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="../qtcore/qpointf.html">QPointF</a></span>(<span class="number">0.6</span><span class="operator">,</span> <span class="number">0.5</span>) <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="../qtcore/qpointf.html">QPointF</a></span>(<span class="number">0.5</span><span class="operator">,</span> <span class="number">0.6</span>)
                     <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="../qtcore/qpointf.html">QPointF</a></span>(<span class="number">0.4</span><span class="operator">,</span> <span class="number">0.5</span>);
  }

</pre>
<p>The <code>paint()</code> function paints the stars in this <code>StarRating</code> object on a paint device:</p>
<pre class="cpp">

  <span class="type">void</span> StarRating<span class="operator">::</span>paint(<span class="type"><a href="../qtgui/qpainter.html">QPainter</a></span> <span class="operator">*</span>painter<span class="operator">,</span> <span class="keyword">const</span> <span class="type"><a href="../qtcore/qrect.html">QRect</a></span> <span class="operator">&amp;</span>rect<span class="operator">,</span>
                         <span class="keyword">const</span> <span class="type"><a href="../qtgui/qpalette.html">QPalette</a></span> <span class="operator">&amp;</span>palette<span class="operator">,</span> EditMode mode) <span class="keyword">const</span>
  {
      painter<span class="operator">-</span><span class="operator">&gt;</span>save();

      painter<span class="operator">-</span><span class="operator">&gt;</span>setRenderHint(<span class="type"><a href="../qtgui/qpainter.html">QPainter</a></span><span class="operator">::</span>Antialiasing<span class="operator">,</span> <span class="keyword">true</span>);
      painter<span class="operator">-</span><span class="operator">&gt;</span>setPen(<span class="type"><a href="../qtcore/qt.html">Qt</a></span><span class="operator">::</span>NoPen);

      <span class="keyword">if</span> (mode <span class="operator">=</span><span class="operator">=</span> Editable) {
          painter<span class="operator">-</span><span class="operator">&gt;</span>setBrush(palette<span class="operator">.</span>highlight());
      } <span class="keyword">else</span> {
          painter<span class="operator">-</span><span class="operator">&gt;</span>setBrush(palette<span class="operator">.</span>foreground());
      }

      <span class="type">int</span> yOffset <span class="operator">=</span> (rect<span class="operator">.</span>height() <span class="operator">-</span> PaintingScaleFactor) <span class="operator">/</span> <span class="number">2</span>;
      painter<span class="operator">-</span><span class="operator">&gt;</span>translate(rect<span class="operator">.</span>x()<span class="operator">,</span> rect<span class="operator">.</span>y() <span class="operator">+</span> yOffset);
      painter<span class="operator">-</span><span class="operator">&gt;</span>scale(PaintingScaleFactor<span class="operator">,</span> PaintingScaleFactor);

      <span class="keyword">for</span> (<span class="type">int</span> i <span class="operator">=</span> <span class="number">0</span>; i <span class="operator">&lt;</span> myMaxStarCount; <span class="operator">+</span><span class="operator">+</span>i) {
          <span class="keyword">if</span> (i <span class="operator">&lt;</span> myStarCount) {
              painter<span class="operator">-</span><span class="operator">&gt;</span>drawPolygon(starPolygon<span class="operator">,</span> <span class="type"><a href="../qtcore/qt.html">Qt</a></span><span class="operator">::</span>WindingFill);
          } <span class="keyword">else</span> <span class="keyword">if</span> (mode <span class="operator">=</span><span class="operator">=</span> Editable) {
              painter<span class="operator">-</span><span class="operator">&gt;</span>drawPolygon(diamondPolygon<span class="operator">,</span> <span class="type"><a href="../qtcore/qt.html">Qt</a></span><span class="operator">::</span>WindingFill);
          }
          painter<span class="operator">-</span><span class="operator">&gt;</span>translate(<span class="number">1.0</span><span class="operator">,</span> <span class="number">0.0</span>);
      }

      painter<span class="operator">-</span><span class="operator">&gt;</span>restore();
  }

</pre>
<p>We first set the pen and brush we will use for painting. The <code>mode</code> parameter can be either <code>Editable</code> or <code>ReadOnly</code>. If <code>mode</code> is editable, we use the <a href="../qtgui/qpalette.html#ColorRole-enum">Highlight</a> color instead of the <a href="../qtgui/qpalette.html#ColorRole-enum">Foreground</a> color to draw the stars.</p>
<p>Then we draw the stars. If we are in <code>Edit</code> mode, we paint diamonds in place of stars if the rating is less than the highest rating.</p>
<p>The <code>sizeHint()</code> function returns the preferred size for an area to paint the stars on:</p>
<pre class="cpp">

  <span class="type"><a href="../qtcore/qsize.html">QSize</a></span> StarRating<span class="operator">::</span>sizeHint() <span class="keyword">const</span>
  {
      <span class="keyword">return</span> PaintingScaleFactor <span class="operator">*</span> <span class="type"><a href="../qtcore/qsize.html">QSize</a></span>(myMaxStarCount<span class="operator">,</span> <span class="number">1</span>);
  }

</pre>
<p>The preferred size is just enough to paint the maximum number of stars. The function is called by both <code>StarDelegate::sizeHint()</code> and <code>StarEditor::sizeHint()</code>.</p>
<a name="the-main-function"></a>
<h2 id="the-main-function">The <code>main()</code> Function</h2>
<p>Here's the program's <code>main()</code> function:</p>
<pre class="cpp">

  <span class="type">int</span> main(<span class="type">int</span> argc<span class="operator">,</span> <span class="type">char</span> <span class="operator">*</span>argv<span class="operator">[</span><span class="operator">]</span>)
  {
      <span class="type"><a href="qapplication.html">QApplication</a></span> app(argc<span class="operator">,</span> argv);

      <span class="type"><a href="qtablewidget.html">QTableWidget</a></span> tableWidget(<span class="number">4</span><span class="operator">,</span> <span class="number">4</span>);
      tableWidget<span class="operator">.</span>setItemDelegate(<span class="keyword">new</span> StarDelegate);
      tableWidget<span class="operator">.</span>setEditTriggers(<span class="type"><a href="qabstractitemview.html">QAbstractItemView</a></span><span class="operator">::</span>DoubleClicked
                                  <span class="operator">|</span> <span class="type"><a href="qabstractitemview.html">QAbstractItemView</a></span><span class="operator">::</span>SelectedClicked);
      tableWidget<span class="operator">.</span>setSelectionBehavior(<span class="type"><a href="qabstractitemview.html">QAbstractItemView</a></span><span class="operator">::</span>SelectRows);

      <span class="type"><a href="../qtcore/qstringlist.html">QStringList</a></span> headerLabels;
      headerLabels <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="string">&quot;Title&quot;</span> <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="string">&quot;Genre&quot;</span> <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="string">&quot;Artist&quot;</span> <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="string">&quot;Rating&quot;</span>;
      tableWidget<span class="operator">.</span>setHorizontalHeaderLabels(headerLabels);

      populateTableWidget(<span class="operator">&amp;</span>tableWidget);

      tableWidget<span class="operator">.</span>resizeColumnsToContents();
      tableWidget<span class="operator">.</span>resize(<span class="number">500</span><span class="operator">,</span> <span class="number">300</span>);
      tableWidget<span class="operator">.</span>show();

      <span class="keyword">return</span> app<span class="operator">.</span>exec();
  }

</pre>
<p>The <code>main()</code> function creates a <a href="qtablewidget.html">QTableWidget</a> and sets a <code>StarDelegate</code> on it. <a href="qabstractitemview.html#EditTrigger-enum">DoubleClicked</a> 和 <a href="qabstractitemview.html#EditTrigger-enum">SelectedClicked</a> are set as <a href="qabstractitemview.html#editTriggers-prop">edit triggers</a>, so that the editor is opened with a single click when the star rating item is selected.</p>
<p>The <code>populateTableWidget()</code> function fills the <a href="qtablewidget.html">QTableWidget</a> with data:</p>
<pre class="cpp">

  <span class="type">void</span> populateTableWidget(<span class="type"><a href="qtablewidget.html">QTableWidget</a></span> <span class="operator">*</span>tableWidget)
  {
      <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct</span> {
          <span class="keyword">const</span> <span class="type">char</span> <span class="operator">*</span>title;
          <span class="keyword">const</span> <span class="type">char</span> <span class="operator">*</span>genre;
          <span class="keyword">const</span> <span class="type">char</span> <span class="operator">*</span>artist;
          <span class="type">int</span> rating;
      } staticData<span class="operator">[</span><span class="operator">]</span> <span class="operator">=</span> {
          { <span class="string">&quot;Mass in B-Minor&quot;</span><span class="operator">,</span> <span class="string">&quot;Baroque&quot;</span><span class="operator">,</span> <span class="string">&quot;J.S. Bach&quot;</span><span class="operator">,</span> <span class="number">5</span> }<span class="operator">,</span>
      ...
          { <span class="number">0</span><span class="operator">,</span> <span class="number">0</span><span class="operator">,</span> <span class="number">0</span><span class="operator">,</span> <span class="number">0</span> }
      };

      <span class="keyword">for</span> (<span class="type">int</span> row <span class="operator">=</span> <span class="number">0</span>; staticData<span class="operator">[</span>row<span class="operator">]</span><span class="operator">.</span>title <span class="operator">!</span><span class="operator">=</span> <span class="number">0</span>; <span class="operator">+</span><span class="operator">+</span>row) {
          <span class="type"><a href="qtablewidgetitem.html">QTableWidgetItem</a></span> <span class="operator">*</span>item0 <span class="operator">=</span> <span class="keyword">new</span> <span class="type"><a href="qtablewidgetitem.html">QTableWidgetItem</a></span>(staticData<span class="operator">[</span>row<span class="operator">]</span><span class="operator">.</span>title);
          <span class="type"><a href="qtablewidgetitem.html">QTableWidgetItem</a></span> <span class="operator">*</span>item1 <span class="operator">=</span> <span class="keyword">new</span> <span class="type"><a href="qtablewidgetitem.html">QTableWidgetItem</a></span>(staticData<span class="operator">[</span>row<span class="operator">]</span><span class="operator">.</span>genre);
          <span class="type"><a href="qtablewidgetitem.html">QTableWidgetItem</a></span> <span class="operator">*</span>item2 <span class="operator">=</span> <span class="keyword">new</span> <span class="type"><a href="qtablewidgetitem.html">QTableWidgetItem</a></span>(staticData<span class="operator">[</span>row<span class="operator">]</span><span class="operator">.</span>artist);
          <span class="type"><a href="qtablewidgetitem.html">QTableWidgetItem</a></span> <span class="operator">*</span>item3 <span class="operator">=</span> <span class="keyword">new</span> <span class="type"><a href="qtablewidgetitem.html">QTableWidgetItem</a></span>;
          item3<span class="operator">-</span><span class="operator">&gt;</span>setData(<span class="number">0</span><span class="operator">,</span>
                         <span class="type"><a href="../qtcore/qvariant.html">QVariant</a></span><span class="operator">::</span>fromValue(StarRating(staticData<span class="operator">[</span>row<span class="operator">]</span><span class="operator">.</span>rating)));

          tableWidget<span class="operator">-</span><span class="operator">&gt;</span>setItem(row<span class="operator">,</span> <span class="number">0</span><span class="operator">,</span> item0);
          tableWidget<span class="operator">-</span><span class="operator">&gt;</span>setItem(row<span class="operator">,</span> <span class="number">1</span><span class="operator">,</span> item1);
          tableWidget<span class="operator">-</span><span class="operator">&gt;</span>setItem(row<span class="operator">,</span> <span class="number">2</span><span class="operator">,</span> item2);
          tableWidget<span class="operator">-</span><span class="operator">&gt;</span>setItem(row<span class="operator">,</span> <span class="number">3</span><span class="operator">,</span> item3);
      }
  }

</pre>
<p>Notice the call to qVariantFromValue to convert a <code>StarRating</code> to a <a href="../qtcore/qvariant.html">QVariant</a>.</p>
<a name="possible-extensions-and-suggestions"></a>
<h2 id="possible-extensions-and-suggestions">Possible Extensions and Suggestions</h2>
<p>There are many ways to customize Qt's <a href="model-view-programming.html">model/view framework</a>. The approach used in this example is appropriate for most custom delegates and editors. Examples of possibilities not used by the star delegate and star editor are:</p>
<ul>
<li>It is possible to open editors programmatically by calling <a href="qabstractitemview.html#edit">QAbstractItemView::edit</a>(), instead of relying on edit triggers. This could be used to support other edit triggers than those offered by the <a href="qabstractitemview.html#EditTrigger-enum">QAbstractItemView::EditTrigger</a> enum. For example, in the Star Delegate example, hovering over an item with the mouse might make sense as a way to pop up an editor.</li>
<li>By reimplementing <a href="qabstractitemdelegate.html#editorEvent">QAbstractItemDelegate::editorEvent</a>(), it is possible to implement the editor directly in the delegate, instead of creating a separate <a href="qwidget.html">QWidget</a> subclass.</li>
</ul>
<p>文件：</p>
<ul>
<li><a href="qtwidgets-itemviews-stardelegate-main-cpp.html">itemviews/stardelegate/main.cpp</a></li>
<li><a href="qtwidgets-itemviews-stardelegate-stardelegate-cpp.html">itemviews/stardelegate/stardelegate.cpp</a></li>
<li><a href="qtwidgets-itemviews-stardelegate-stardelegate-h.html">itemviews/stardelegate/stardelegate.h</a></li>
<li><a href="qtwidgets-itemviews-stardelegate-stardelegate-pro.html">itemviews/stardelegate/stardelegate.pro</a></li>
<li><a href="qtwidgets-itemviews-stardelegate-stareditor-cpp.html">itemviews/stardelegate/stareditor.cpp</a></li>
<li><a href="qtwidgets-itemviews-stardelegate-stareditor-h.html">itemviews/stardelegate/stareditor.h</a></li>
<li><a href="qtwidgets-itemviews-stardelegate-starrating-cpp.html">itemviews/stardelegate/starrating.cpp</a></li>
<li><a href="qtwidgets-itemviews-stardelegate-starrating-h.html">itemviews/stardelegate/starrating.h</a></li>
</ul>
</div>
<!-- @@@itemviews/stardelegate -->
        </div>
       </div>
   </div>
   </div>
</div>
<div class="footer">
   <p>
   <acronym title="Copyright">&copy;</acronym> 2018 The Qt Company Ltd.
   Documentation contributions included herein are the copyrights of
   their respective owners.<br/>    The documentation provided herein is licensed under the terms of the    <a href="http://www.gnu.org/licenses/fdl.html">GNU Free Documentation    License version 1.3</a> as published by the Free Software Foundation.<br/>    Qt and respective logos are trademarks of The Qt Company Ltd.     in Finland and/or other countries worldwide. All other trademarks are property
   of their respective owners. </p>
</div>
</body>
</html>
